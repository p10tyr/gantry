<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capacity Calculator Tests</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-pass { background-color: #d4edda; }
        .test-fail { background-color: #f8d7da; }
        .test-result { padding: 10px; margin: 5px 0; border-radius: 4px; font-family: monospace; }
        .test-section { margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>Capacity Calculator Tests</h1>
        <div id="test-results"></div>
    </div>

    <script>
        // Test utilities
        const tests = [];
        
        function test(name, fn) {
            tests.push({ name, fn });
        }

        function assert(condition, message) {
            if (!condition) {
                throw new Error(message);
            }
        }

        function assertEquals(actual, expected, message) {
            if (actual !== expected) {
                throw new Error(`${message}\nExpected: ${expected}\nActual: ${actual}`);
            }
        }

        // Helper functions (copied from app.js)
        function parseDate(dateString) {
            return new Date(dateString + 'T00:00:00');
        }

        function getDateAtAge(dob, age) {
            const date = parseDate(dob);
            return new Date(date.getFullYear() + age, date.getMonth(), date.getDate());
        }

        function calculateAgeAtDate(dob, atDate) {
            const birthDate = parseDate(dob);
            let age = atDate.getFullYear() - birthDate.getFullYear();
            const m = atDate.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && atDate.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        function calculateAge(dob) {
            return calculateAgeAtDate(dob, new Date());
        }

        // Test data
        const TEST_DATA = [
            { name: 'Alice', dateOfBirth: '2020-01-15' },  // Born Jan 2020, turns 4 in Jan 2024, turns 6 in Jan 2026
            { name: 'Bob', dateOfBirth: '2019-06-20' },    // Born Jun 2019, turns 4 in Jun 2023, turns 6 in Jun 2025
            { name: 'Charlie', dateOfBirth: '2018-03-10' }, // Born Mar 2018, turns 4 in Mar 2022, turns 6 in Mar 2024
            { name: 'Diana', dateOfBirth: '2017-11-05' },   // Born Nov 2017, turns 4 in Nov 2021, turns 6 in Nov 2023
            { name: 'Eve', dateOfBirth: '2016-07-30' },     // Born Jul 2016, turns 4 in Jul 2020, turns 6 in Jul 2022
        ];

        // Age calculation tests
        test('Age calculation - person born 2020-01-15 should be correct', () => {
            const age = calculateAge('2020-01-15');
            // Today is 2026-01-15, so age should be 6
            console.log('Alice age:', age);
            assert(age >= 5 && age <= 6, `Age should be 5 or 6, got ${age}`);
        });

        test('Calculate age at specific date', () => {
            // Test age at date function
            const ageAt2024 = calculateAgeAtDate('2020-01-15', new Date(2024, 0, 1)); // Jan 1, 2024
            console.log('Alice age on 2024-01-01:', ageAt2024);
            assertEquals(ageAt2024, 3, 'Should be 3 years old on 2024-01-01');

            const ageAt2024b = calculateAgeAtDate('2020-01-15', new Date(2024, 0, 15)); // Jan 15, 2024
            console.log('Alice age on 2024-01-15:', ageAt2024b);
            assertEquals(ageAt2024b, 4, 'Should be 4 years old on 2024-01-15 (birthday)');
        });

        test('Age calculation - person born 2016-07-30 should be 9', () => {
            const age = calculateAge('2016-07-30');
            // Today is 2026-01-15, person hasn't had birthday yet in 2026
            console.log('Eve age:', age);
            assert(age === 9, `Age should be 9, got ${age}`);
        });

        // Date transition tests
        test('Squirrels to Beavers transition - born 2020-01-15 turns 6 on 2026-01-15', () => {
            const dob = '2020-01-15';
            const turnsDate = getDateAtAge(dob, 6);
            assertEquals(turnsDate.getFullYear(), 2026, 'Year should be 2026');
            assertEquals(turnsDate.getMonth(), 0, 'Month should be January (0)');
            assertEquals(turnsDate.getDate(), 15, 'Date should be 15');
        });

        test('Beavers to Cubs transition - born 2020-01-15 turns 8 on 2028-01-15', () => {
            const dob = '2020-01-15';
            const turnsDate = getDateAtAge(dob, 8);
            assertEquals(turnsDate.getFullYear(), 2028, 'Year should be 2028');
            assertEquals(turnsDate.getMonth(), 0, 'Month should be January (0)');
            assertEquals(turnsDate.getDate(), 15, 'Date should be 15');
        });

        // Capacity calculation tests
        test('Capacity calculation - 2026 with test data', () => {
            const AGE_START = 4;
            const AGE_END = 18;
            const capacity = {};
            
            for (let year = 2020; year <= 2030; year++) {
                capacity[year] = { total: 0, squirrels: 0, beavers: 0, cubs: 0, scouts: 0, explorers: 0 };
            }

            // Process each person
            TEST_DATA.forEach(person => {
                const dob = person.dateOfBirth;
                const startDate = getDateAtAge(dob, AGE_START);
                const endDate = getDateAtAge(dob, AGE_END);

                console.log(`\n${person.name} (DOB: ${dob})`);
                console.log(`  Starts (age 4): ${startDate.toDateString()}`);
                console.log(`  Ends (age 18): ${endDate.toDateString()}`);

                for (let year = 2020; year <= 2030; year++) {
                    const yearStart = new Date(year, 0, 1);
                    const yearEnd = new Date(year, 11, 31);
                    
                    // Calculate age at the start of the year using the proper age calculation
                    const ageAtYearStart = calculateAgeAtDate(dob, yearStart);
                    
                    if (startDate <= yearEnd && endDate >= yearStart) {
                        // Only count if they're actually in the age range at year start
                        if (ageAtYearStart >= 4 && ageAtYearStart < 18) {
                            capacity[year].total++;
                            
                            console.log(`  ${year}: Age at year start (${yearStart.toDateString()}) = ${ageAtYearStart}`);
                            
                            if (ageAtYearStart >= 4 && ageAtYearStart < 6) {
                                capacity[year].squirrels++;
                                console.log(`    -> Squirrels`);
                            } else if (ageAtYearStart >= 6 && ageAtYearStart < 8) {
                                capacity[year].beavers++;
                                console.log(`    -> Beavers`);
                            } else if (ageAtYearStart >= 8 && ageAtYearStart < 10.5) {
                                capacity[year].cubs++;
                                console.log(`    -> Cubs`);
                            } else if (ageAtYearStart >= 10.5 && ageAtYearStart < 14) {
                                capacity[year].scouts++;
                                console.log(`    -> Scouts`);
                            } else if (ageAtYearStart >= 14 && ageAtYearStart < 18) {
                                capacity[year].explorers++;
                                console.log(`    -> Explorers`);
                            }
                        }
                    }
                }
            });

            // Log results for debugging
            console.log('\n\n=== CAPACITY BY YEAR ===');
            for (let year = 2020; year <= 2030; year++) {
                console.log(`${year}: Total=${capacity[year].total} S=${capacity[year].squirrels} B=${capacity[year].beavers} C=${capacity[year].cubs} Sc=${capacity[year].scouts} E=${capacity[year].explorers}`);
            }

            // Verify specific years
            console.log('\n=== TESTS ===');
            console.log(`2022: Expected total=3, got ${capacity[2022].total}`);
            console.log(`2022: Expected squirrels=2, got ${capacity[2022].squirrels}`);
            console.log(`2022: Expected beavers=1, got ${capacity[2022].beavers}`);

            console.log(`2024: Expected total=4, got ${capacity[2024].total}`);
            console.log(`2024: Expected squirrels=1, got ${capacity[2024].squirrels}`);
            console.log(`2024: Expected beavers=2, got ${capacity[2024].beavers}`);
            console.log(`2024: Expected cubs=1, got ${capacity[2024].cubs}`);

            console.log(`2026: Expected total=5, got ${capacity[2026].total}`);
            console.log(`2026: Expected beavers=1, got ${capacity[2026].beavers}`);

            // Test 2026 specifically - we know all 5 should be present
            assertEquals(capacity[2026].total, 5, '2026 should have 5 people (all)');
            
            // Additional verification tests
            assert(capacity[2022].total >= 2, '2022 should have at least 2 people');
            assert(capacity[2024].total >= 3, '2024 should have at least 3 people');
            
            // Verify section totals add up to total
            for (let year = 2020; year <= 2030; year++) {
                const sectionTotal = capacity[year].squirrels + capacity[year].beavers + capacity[year].cubs + capacity[year].scouts + capacity[year].explorers;
                assertEquals(sectionTotal, capacity[year].total, `${year} section totals (${sectionTotal}) should equal total (${capacity[year].total})`);
            }
        });

        // Run tests
        async function runTests() {
            const resultsDiv = document.getElementById('test-results');
            let passed = 0;
            let failed = 0;

            for (const { name, fn } of tests) {
                try {
                    fn();
                    resultsDiv.innerHTML += `<div class="test-result test-pass"><strong>✓ PASS:</strong> ${name}</div>`;
                    passed++;
                } catch (error) {
                    resultsDiv.innerHTML += `<div class="test-result test-fail"><strong>✗ FAIL:</strong> ${name}<br><small>${error.message}</small></div>`;
                    failed++;
                }
            }

            resultsDiv.innerHTML += `<div class="alert alert-info mt-4"><strong>Summary:</strong> ${passed} passed, ${failed} failed out of ${tests.length} tests</div>`;
        }

        // Run tests when page loads
        window.addEventListener('load', runTests);
    </script>
</body>
</html>
